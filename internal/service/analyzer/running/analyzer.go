package running

import (
	"context"
	"fitgo/internal/service/ai/client"
	aiservice "fitgo/internal/service/ai/service"
	"fitgo/internal/service/coros"
	"fitgo/pkg/config"
	"fmt"
)

// RunAnalyzer åˆ†æè¿åŠ¨æ•°æ®å¹¶è¿”å›AIåˆ†æç»“æœ
func RunAnalyzer(userID, sportID string) (string, error) {
	// 1. åŠ è½½é…ç½®
	cfg, err := config.LoadDefaultConfig()
	if err != nil {
		return "", fmt.Errorf("åŠ è½½é…ç½®å¤±è´¥: %v", err)
	}

	// 2. åˆ›å»º AI æœåŠ¡
	aiService, err := aiservice.NewAIService(&cfg.AI)
	if err != nil {
		return "", fmt.Errorf("åˆ›å»º AI æœåŠ¡å¤±è´¥: %v", err)
	}

	// 3. è·å–è¿åŠ¨æ¦‚è¦
	sportsSummary, err := coros.NewCorosService().SportsSummary(userID, sportID)
	if err != nil {
		return "", fmt.Errorf("è·å–è¿åŠ¨æ¦‚è¦å¤±è´¥: %v", err)
	}

	// 4. å‡†å¤‡æç¤ºè¯
	prompt := fmt.Sprintf(`
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è¿åŠ¨æ•°æ®åˆ†æåŠ©æ‰‹ã€‚è¯·åˆ†æä»¥ä¸‹é«˜é©°è¿åŠ¨æ•°æ®ï¼š

ã€è¦æ±‚ã€‘
**ä¸¥æ ¼æŒ‰ç…§è§„åˆ™è½¬æ¢**ã€‚åªæ˜¾ç¤ºæœ€ç»ˆæ ¼å¼åŒ–æ—¶é—´/è·ç¦»ï¼Œ**ä¸æ˜¾ç¤ºä»»ä½•åŸå§‹å€¼å’Œè®¡ç®—è¿‡ç¨‹**ã€‚

ã€æ—¶é—´æ ¼å¼åŒ–è§„åˆ™ã€‘
æ‰€æœ‰æ—¶é—´ï¼ˆè¿åŠ¨æ—¶é—´ã€æš‚åœæ—¶é—´ã€é…é€Ÿç­‰ï¼‰å­—æ®µè½¬æ¢ä¸ºæ˜“è¯»æ ¼å¼ï¼š
1. **åŸºç¡€è½¬æ¢**: åŸå§‹å€¼ Ã· 100 = **æ€»ç§’æ•° (S)**ã€‚
2. **å°æ—¶/åˆ†é’Ÿ/ç§’è½¬æ¢é€»è¾‘**:
   - å¦‚æœ S < 60ç§’: S ç§’ã€‚
   - å¦‚æœ 60ç§’ â‰¤ S < 3600ç§’ (60åˆ†é’Ÿ): **åˆ†:ç§’** (M:SS)ã€‚
   - å¦‚æœ S â‰¥ 3600ç§’ (1å°æ—¶): **æ—¶:åˆ†:ç§’** (H:MM:SS)ã€‚

**ç‰¹åˆ«æé†’ï¼šè¯·ç¡®ä¿ç§’æ•°è½¬æ¢ä¸ºåˆ†é’Ÿå’Œå°æ—¶çš„è®¡ç®—å‡†ç¡®æ— è¯¯ï¼Œä¾‹å¦‚ï¼š**
- **é”™è¯¯ç¤ºä¾‹ï¼š** 389678 (3896.78 ç§’) **é”™è¯¯åœ°** è½¬æ¢ä¸º 6:29:28 (å°æ—¶:åˆ†:ç§’)
- **æ­£ç¡®ç¤ºä¾‹ï¼š** 389678 (3896.78 ç§’) **åº”è½¬æ¢ä¸º 1:04:57** (æ—¶:åˆ†:ç§’)
- 349038 â†’ 58:10 (å°äº1å°æ—¶)
- 756000 â†’ 2:06:00 (å¤§äº1å°æ—¶)

ã€è·ç¦»æ ¼å¼åŒ–è§„åˆ™ã€‘
è·ç¦»å­—æ®µè½¬æ¢ä¸ºæ˜“è¯»æ ¼å¼:
- åŸå§‹å€¼ Ã· 1000 = å…¬é‡Œã€‚
- è·ç¦»æ™ºèƒ½è½¬æ¢: å•ä½ç±³ï¼Œ1001179 è½¬æ¢æˆ 10.01å…¬é‡Œã€‚

ã€é…é€Ÿå­—æ®µè¯´æ˜ã€‘
- adjustedPaceã€avgPace å•ä½æ˜¯ï¼šç§’/å…¬é‡Œ
   - è½¬æ¢å…¬å¼ï¼šç§’/å…¬é‡Œ â†’ åˆ†é’Ÿ:ç§’/å…¬é‡Œ
   - ç¤ºä¾‹ï¼š373ç§’/å…¬é‡Œ = 6åˆ†13ç§’/å…¬é‡Œ (373Ã·60=6ä½™13)

ã€åˆ†ææŠ¥å‘Šæ¨¡æ¿ã€‘
è¯·ä¸¥æ ¼è¾“å‡ºä»¥ä¸‹å››ä¸ªéƒ¨åˆ†å†…å®¹ï¼Œå¹¶ä½¿ç”¨Markdownè¡¨æ ¼æ ¼å¼ï¼š
### **ä¸€ã€ ğŸ¯ è¿åŠ¨è¡¨ç°æ€»ç»“ (Summary)**
[åŒ…å«æ€»è·ç¦»ã€è¿åŠ¨æ—¶é—´ã€å¹³å‡é…é€Ÿã€æœ€å¿«é…é€Ÿã€æ€»æš‚åœæ—¶é—´ï¼Œå¹¶ç»™å‡º 1-2 å¥æ ¸å¿ƒæ´å¯Ÿã€‚]

### **äºŒã€ ğŸ“Š å…³é”®ç”Ÿç†ä¸æŠ€æœ¯æŒ‡æ ‡ (Metrics)**
[åŒ…å«å¹³å‡å¿ƒç‡ã€å¹³å‡æ­¥é¢‘ã€å¹³å‡åŠŸç‡ã€è®­ç»ƒè´Ÿè·ç­‰ï¼Œå¹¶è¿›è¡Œç®€çŸ­åˆ†æã€‚]

### **ä¸‰ã€ ğŸ“ˆ æ¯å…¬é‡Œé…é€Ÿç¨³å®šæ€§åˆ†æ (Pace Consistency)**
[åˆ†æå‰ã€ä¸­ã€æœ«æ®µçš„é…é€Ÿå’Œå¿ƒç‡å˜åŒ–ï¼Œæ€»ç»“èŠ‚å¥æ§åˆ¶å’Œç–²åŠ³å‡ºç°çš„å…³é”®å‘ç°ã€‚]

### **å››ã€ ğŸ’¡ é’ˆå¯¹æ€§æ”¹è¿›å»ºè®® (Actionable Advice)**
[ç»™å‡ºè‡³å°‘ 3 æ¡ä¼˜å…ˆçº§å»ºè®®ï¼šæé«˜é€Ÿåº¦è€åŠ›ã€å¼ºåŒ–è·‘æ­¥ç»æµæ€§ã€ä¼˜åŒ–åŠŸç‡è®­ç»ƒã€‚]

è¿åŠ¨æ•°æ®ï¼š
æ¯åœˆæ•°æ®ï¼š%s
æ€»ç»“æ•°æ®ï¼š%s`,
		sportsSummary.LapList, sportsSummary.Summary)
	// 5. è°ƒç”¨AIæœåŠ¡
	response, err := aiService.Chat(context.Background(), []client.ChatMessage{
		{
			Role:    "user",
			Content: prompt,
		},
	})
	if err != nil {
		return "", fmt.Errorf("AIåˆ†æå¤±è´¥: %v", err)
	}

	return response, nil
}
